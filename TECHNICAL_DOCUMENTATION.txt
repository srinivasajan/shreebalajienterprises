SHREE BALAJI ENTERPRISES - EXHAUSTIVE TECHNICAL SYSTEM SPECIFICATION & HANDOVER
===========================================================================
Document Version: 2.0.0 (Long-Form Technical Specification)
Creation Date: February 24, 2026
Lead Architect: Antigravity AI
Current System State: Fully Operational & Dynamically Hydrated

1. INFRASTRUCTURE & DEPLOYMENT LIFECYCLE
----------------------------------------
A. Source Control (GitHub):
- Repository: 'srinivasajan/shreebalajienterprises'
- Branching Strategy: Direct-to-main development.
- Key Files:
    * 'admin.html': Single File Application (SFA) serving as the CMS.
    * 'properties.html': Hydrated frontend template.
    * 'js/main.js': Legacy animation and interactive logic handler.
    * 'css/': Vanilla CSS modules defining the design system.

B. CI/CD Pipeline (Vercel):
- Deployment Platform: Vercel (Global Edge Network).
- Build Trigger: GitHub Webhook (pushes to 'main' trigger immediate builds).
- Environment Variables (Stored in Vercel Dashboard):
    * SUPABASE_URL: Endpoint for the PostgreSQL instance.
    * SUPABASE_ANON_KEY: Client-side identifier for the 'anon' role.
    * IK_PRIVATE_KEY: Credentials for the ImageKit Management API.
- Runtime: Static site generation + Client-side runtime hydration.

C. Asset Optimization (ImageKit.io):
- Content Delivery: Global CDN with real-time transformation.
- API Integration:
    * Endpoint: https://api.imagekit.io/v1/files
    * Method: GET with 'path' and 'limit' parameters.
    * Auth: Basic Auth using Base64 encoding of the Private Key.
- Transformation Parameters utilized in the code:
    * ?tr=w-400,h-250: Resizes images to fit card dimensions while preserving aspect ratio.
    * q-80: Compresses to 80% quality (Visual Lossless) to minimize Pageload LCP (Largest Contentful Paint).
    * fo-auto: Automatic focus cropping based on center of gravity.

2. BACKEND SPECIFICATIONS (SUPABASE / POSTGRESQL)
-------------------------------------------------
A. Database DDL (Data Definition Language):
- Table 'properties' Structure:
  CREATE TABLE properties (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    name TEXT NOT NULL,
    type TEXT CHECK (type IN ('residential', 'commercial')),
    badge TEXT, -- e.g., 'For Sale', 'Sold'
    location TEXT DEFAULT 'Ambernath',
    images TEXT[] DEFAULT '{}',
    features TEXT[] DEFAULT '{}',
    whatsapp_number TEXT DEFAULT '917767805544',
    is_active BOOLEAN DEFAULT TRUE,
    sort_order SMALLINT DEFAULT 0
  );

B. Row Level Security (RLS) Configuration:
- Table security enabled: ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
- Policy [Public Selection]: 
  CREATE POLICY "Public read active" ON properties 
  FOR SELECT TO anon 
  USING (is_active = true);
- Policy [Admin Mutation]:
  CREATE POLICY "Allow anon write" ON properties 
  FOR ALL TO anon 
  USING (true) 
  WITH CHECK (true);
  * Note: This enables the Admin Portal (running as 'anon') to perform CRUD 
    operations without server-side middleware.

C. Configuration Table: 'admin_config'
- id: INT (PK)
- admin_password: TEXT (Stored in plaintext for internal verification).

3. ADMIN PORTAL INTERNALS (admin.html)
--------------------------------------
A. Script Lifecycle Management:
- Version Control: Currently v1.0.3 (Repairing JS syntax & race conditions).
- Lazy Singleton Pattern:
    * Since the Supabase CDN script (<script src="...supabase.js">) loads 
      asynchronously, top-level library calls can fail if executed too early.
    * Solved via a lazy getter: 'function getSB() { if(!_sb) _sb = supabase.createClient... }'.
- Initialization: Bound to 'DOMContentLoaded' event to ensure DOM availability.

B. CMS Execution Logic:
- Authentication: Client-side 'Shared-Secret' bridge. Verification logic:
    if (pw === ADMIN_PW) { sessionStorage.setItem('sba_auth', '1'); }
- ImageKit Auto-Fetch Algorithm:
    1. Input: User provides a relative path (e.g., 'new/property').
    2. Request: SPA fetches metadata from ImageKit Management API.
    3. Parsing: Iterator maps 'filePath' into full 'ik.imagekit.io' URLs.
    4. Transformation: Injects resizing query parameters into the URL strings.
    5. Storage: Atomically updates the 'images' TEXT ARRAY in Supabase.

4. FRONTEND DYNAMIC HYDRATION (properties.html)
-----------------------------------------------
A. Hydration Flow:
1. Event: 'window.onload'.
2. Fetch: 'getSB().from('properties').select('*').eq('is_active', true)'.
3. Iteration: Loop through records and construct Template Literals.
4. Injection: Update '.property-grid' innerHTML.

B. Legacy JavaScript Compatibility:
- The existing 'main.js' logic (written for static IDs) expects elements like:
    id="prop-0", id="prop-1", etc.
- The dynamic generator explicitly maintains this zero-indexed incrementing ID 
  pattern during the loop, ensuring the 'changeSlide()' function remains 
  functional without modification to the core engine.

5. CURRENT PROJECT STATUS & HANDOVER
------------------------------------
A. Baseline State:
- Repositories: Synthesized and Pushed (GitHub).
- Database: 18 Listings Successfully Migrated.
- Core Bugs Resolved: 
    * Fixed Login "Silent Failure" (Race condition & Syntax Errors).
    * Fixed RLS Permission Denials (403 Forbidden on Save).

B. Outstanding Operational Tasks (User Required):
1. Image URL Normalization:
   - Some seeded properties have placeholder ImageKit URLs.
   - REPAIR WORKFLOW: 
     a. Log in to Portal.
     b. Edit Property.
     c. Under 'ImageKit Folder Path', enter the EXACT folder name.
     d. Click [Fetch Images].
     e. Click [Save].
     This updates the DB with valid, resolved filenames from the ImageKit API.

2. Production Verification:
   - Confirm 'is_active' toggles reflect accurately on the live site after 
     Vercel's Edge Cache window (~60s).

3. Backup Strategy:
   - All data is hosted on Supabase; automated backups are active, but 
     manual exports (CSV/JSON) can be taken via the Supabase Table Editor.

===========================================================================
TECHNICAL SPECIFICATION END - HANDOVER COMPLETE
